> 链接：https://mp.weixin.qq.com/s/LIeb5DwMS6RS2YhEw47GDA

> 理解 TCP 实现的部分细节

每个人，对于 TCP 协议可以说是熟悉的，也可以说是不熟悉的。
熟悉，是因为它的三次握手、四次挥手、滑动窗口、慢启动、拥塞避免、拥塞控制等概念好像都有些了解。说不熟悉，是因为它很复杂，在运行过程中网络环境会变化，TCP 的相关机制也会产生相关的适应行为。

## TCP 是一个面向连接可靠的传输层协议，但什么是面向连接可靠呢？
TCP 协议复杂的原因，就是因为 IP 协议的交付质量，IP 是面向无连接不可靠的协议，TCP 需要基于它去设计一个面向连接可靠的传输层协议
## 什么是面向连接？
发送方关心接收方是否处于可接收数据的状态，并且关心传输时，数据之间的关系。
## 什么是可靠？
数据在传输过程中不会被损坏或者丢失，保证数据可以正确到达。
## 如何解决面向连接的问题？
通过建立连接，传输数据，断开连接的三步骤，创建一个长期的数据传输机制，在同一个连接中的数据传输有上下文关系。所以引申出了：
seq 序列号字段，维护传输数据的顺序关系，保证按序交付，同时，解决数据包重复的问题。
syn，ack，fin，rst 字段的值，创建、断开和维护一个连接。

```
- SYN：建立连接。在三次握手的第一步和第二步中使用。SYN 为 1 时，表示这是一个连接请求或连接接受请求
- ACK：确认收到的数据。TCP 规定，连接建立后，ACK 必须置为 1
- FIN：释放连接
- RST：重置连接
```

## 如何解决可靠性的问题？
引入数据确认机制，发送方发送数据后，等待对方确认。（停止等待协议）维护确认字段 Acknowledgement 和 ack 状态。
引入数据确认机制后，引发了带宽利用率不高的问题，解决方案：引入滑动窗口确认机制，即发送多个包之后，一起确认。
引入窗口后，如何在不同延时的网络上，确定窗口的大小？解决方案：引入窗口变量和窗口检测通告。

```
因为 TCP 协议是双向数据流，所以双方（发送方和接收方）都需要维护自己的发送窗口和接收窗口大小（左右边界），窗口大小的调整是一个动态过程，如下。
- 发送方根据网络状况和自身处理能力调整发送窗口
- 接收方根据自身处理能力调整接收窗口，并通过 ACK 通告给发送方
- 发送方根据接收方通告的窗口大小调整自己的发送窗口
这个过程持续进行且不是严格的轮流顺序。窗口的初始大小在三次握手时会协商好。
窗口检测通告，是为了让发送方检测到接收方的窗口何时再打开的定时器机制。例如，接收方缓冲区已满，会设置 ACK=0 并响应给发送方。发送方收到后，会启动一个持续计时器，每次倒计时结束，都会发送一个窗口探测数据包。
```

```
窗口检测通告机制，避免了死锁。场景如下。
- 接收方的窗口变为 0，通过 ACK 告诉发送方
- 过了一段时间，接收方的窗口不为 0 了，通知发送方，但是通知的数据包丢失了（接收方不会主动重传 ACK）
- 发送方一直等待窗口打开，接收方一直等待新数据
做完上面的事情后，带宽可以被充分利用了，但是网络环境是复杂的
```